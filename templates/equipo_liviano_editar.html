{% extends "base.html" %}
{% block title %}Editar Equipo Liviano{% endblock %}

{% block content %}
<div class="reporte-header d-flex justify-content-between align-items-start gap-3 mb-3">
  <div>
    <h1 class="mb-1">Editar Equipo Liviano</h1>
    <div class="text-muted">
      Reporte #{{ r.id }} | {{ r.fecha }} | {{ r.turno }} | Estado: {{ r.estado }}
    </div>
  </div>
  {% include "_nav_reporte.html" %}
</div>

{% if error %}
  <div class="alert alert-danger">{{ error }}</div>
{% endif %}

<div class="card">
  <div class="card-header fw-bold">Editar registro</div>

  <div class="card-body">
    {# Nota UX: si falla validaci√≥n, preserva lo escrito con request.form #}
    <form method="post" class="row g-2 align-items-end">

      <div class="col-md-4">
        <label class="form-label">Camioneta</label>
      
        {# Detectar si el registro actual es manual (no est√° en lista) #}
        {% set it_cam = it.camioneta|string %}
        {% set es_manual_it = (it_cam not in (camionetas | map('string') | list)) %}
      
        {# Valor seleccionado: si hay POST, respetarlo; si no, usar fijo o __OTRA__ #}
        {% set sel_camioneta = request.form.get('camioneta', '__OTRA__' if es_manual_it else it_cam) %}
      
        <select class="form-select" name="camioneta" required>
          <option value="">Seleccione...</option>
          {% for c in camionetas %}
          {% set c_str = c|string %}
          <option value="{{ c_str }}" {% if c_str==(sel_camioneta|string) %}selected{% endif %}>
            {{ c_str }}
          </option>
          {% endfor %}
          <option value="__OTRA__" {% if sel_camioneta=="__OTRA__" %}selected{% endif %}>
            Otra (manual)
          </option>
        </select>
      
        <div class="mt-2 d-none" id="wrapCamionetaManual">
          <label class="form-label">Camioneta (manual - n√∫mero)</label>
          <input class="form-control" type="number" name="camioneta_manual" min="0" step="1" placeholder="Ej: 2059"
            value="{{ request.form.get('camioneta_manual', it_cam if es_manual_it else '') }}">
          <div class="form-text">Solo aplica para este reporte (no se guarda en la lista).</div>
        </div>
      </div>


      <div class="col-md-3">
        <label class="form-label">Estado</label>
        {% set sel_estado = request.form.get('estado', it.estado) %}
        <select class="form-select" name="estado" required>
          <option value="OK" {% if sel_estado == "OK" %}selected{% endif %}>OK</option>
          <option value="PM" {% if sel_estado == "PM" %}selected{% endif %}>PM</option>
          <option value="DOWN" {% if sel_estado == "DOWN" %}selected{% endif %}>DOWN</option>
        </select>
      </div>

      <div class="col-md-5">
        <label class="form-label">Comentario</label>
        <input class="form-control"
               name="comentario"
               value="{{ request.form.get('comentario', it.comentario) }}"
               placeholder="Opcional">
      </div>

      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary">üíæ Guardar</button>
        <a class="btn btn-outline-secondary" href="/reportes/{{ r.id }}/equipo_liviano">‚ùå Cancelar</a>
      </div>

      <script>
        (function () {
          const sel = document.querySelector('select[name="camioneta"]');
          const wrap = document.getElementById('wrapCamionetaManual');
          if (!sel || !wrap) return;

          function toggle() {
            const isOtra = sel.value === "__OTRA__";
            wrap.classList.toggle("d-none", !isOtra);
          }
          sel.addEventListener("change", toggle);
          toggle();
        })();
      </script>

    </form>
  </div>
</div>
{% endblock %}
