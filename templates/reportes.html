{% extends "base.html" %}
{% block title %}Reportes{% endblock %}

{% block content %}

<!-- =====================================================
  [REPORTES] HEADER: TÃ­tulo + BotÃ³n Nuevo reporte
===================================================== -->
<div class="header-reportes">
  <h2 class="m-0">Reportes</h2>

  <div class="acciones-header">
    {% if g.user.rol in ["ADMIN", "SUPERVISOR"] %}
      <a class="btn btn-primary" href="/reportes/nuevo">ğŸ“ Nuevo reporte</a>
    {% endif %}

  </div>
</div>

<!-- =====================================================
  [REPORTES] BUSCAR / FILTRAR (GET)
===================================================== -->
<form method="GET" action="/reportes" class="card card-body mb-3">
  <div class="row g-2 align-items-end">

    <div class="col-6 col-md-2">
      <label class="form-label">Mina</label>
      {% set mina_sel = request.args.get('mina','') %}
      <select class="form-select" name="mina">
        <option value="" {% if mina_sel == "" %}selected{% endif %}>Todas</option>
        <option value="ED" {% if mina_sel == "ED" %}selected{% endif %}>ED</option>
        <option value="PB" {% if mina_sel == "PB" %}selected{% endif %}>PB</option>
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label">Estado</label>
      {% set estado_sel = request.args.get('estado','') %}
      <select class="form-select" name="estado">
        <option value="" {% if estado_sel == "" %}selected{% endif %}>Todos</option>
        <option value="ABIERTO" {% if estado_sel == "ABIERTO" %}selected{% endif %}>ABIERTO</option>
        <option value="CERRADO" {% if estado_sel == "CERRADO" %}selected{% endif %}>CERRADO</option>
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label">Turno</label>
      {% set turno_sel = request.args.get('turno','') %}
      <select class="form-select" name="turno">
        <option value="" {% if turno_sel == "" %}selected{% endif %}>Todos</option>
        <option value="DIA" {% if turno_sel == "DIA" %}selected{% endif %}>DÃA</option>
        <option value="NOCHE" {% if turno_sel == "NOCHE" %}selected{% endif %}>NOCHE</option>
      </select>
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label">Desde</label>
      <input class="form-control" type="date" name="desde" value="{{ request.args.get('desde','') }}">
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label">Hasta</label>
      <input class="form-control" type="date" name="hasta" value="{{ request.args.get('hasta','') }}">
    </div>

    <div class="col-12 col-md-4 d-flex gap-2">
      <button class="btn btn-primary" type="submit">ğŸ” Buscar</button>
      <a class="btn btn-outline-secondary" href="/reportes">ğŸ§¹ Limpiar</a>
    </div>

  </div>
</form>


{% if reportes|length == 0 %}
  <div class="alert alert-warning">AÃºn no hay reportes.</div>
{% else %}

  <!-- =====================================================
    [REPORTES] WRAPPER: Scroll SOLO de la tabla
  ===================================================== -->
  <div class="table-reportes-wrap">
    <div class="table-responsive">
      <table class="table table-striped table-reportes">
        <thead class="table-dark">
          <tr>
            <th class="col-id">ID</th>
            <th class="col-fecha">Fecha</th>
            <th class="col-turno">Turno</th>
            <th class="col-mina">Mina</th>
            <th class="col-estado">Estado</th>
            <th class="col-accion">Acciones</th>
          </tr>
        </thead>

        <tbody>
        {% for r in reportes %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.fecha }}</td>
            <td>{{ r.turno }}</td>
            <td>{{ mina_label(r.mina) }}</td>
            <td>{{ r.estado }}</td>

            <td class="td-accion">
              <div class="acciones-reportes-scroll">
                <div class="acciones-reportes">

                  <a class="btn btn-sm btn-outline-primary" href="/reportes/{{ r.id }}/resumen">
                    ğŸ“„ Resumen
                  </a>

                  {% set can_close = g.user and g.user.rol in ["ADMIN", "SUPERVISOR"] %}

                  {% if r.estado == "ABIERTO" %}
                    <a class="btn btn-sm btn-outline-verde" href="/reportes/{{ r.id }}">
                      ğŸ“‚ Secciones
                    </a>

                    {% if can_close %}
                      <form action="/reportes/{{ r.id }}/cerrar" method="post" class="m-0">
                        <button class="btn btn-sm btn-outline-verde" type="submit"
                                onclick="return confirm('Â¿Seguro que deseas cerrar este reporte?');">
                          ğŸ”’ Cerrar
                        </button>
                      </form>
                    {% endif %}

                  {% else %}
                    <a class="btn btn-sm btn-outline-primary" href="/reportes/{{ r.id }}">
                      ğŸ“‚ Secciones
                    </a>

                    {% if can_close %}
                      <form action="/reportes/{{ r.id }}/reabrir" method="post" class="m-0">
                        <button class="btn btn-sm btn-outline-warning" type="submit"
                                onclick="return confirm('Â¿Seguro que deseas reabrir este reporte?');">
                          ğŸ”“ Reabrir
                        </button>
                      </form>
                    {% endif %}
                  {% endif %}

                  {% if g.user and g.user.rol == "ADMIN" %}
                  <form method="POST" action="/reportes/{{ r.id }}/eliminar" class="m-0" onsubmit="
                          const txt = prompt('Escriba: ELIMINAR {{ r.id }} para confirmar');
                          if (txt === null) return false; // cancelÃ³
                          this.querySelector('input[name=confirmar]').value = txt;
                          return true; // siempre envÃ­a, backend decide si es vÃ¡lido
                        ">
                    <input type="hidden" name="confirmar" value="">
                    <button class="btn btn-sm btn-outline-danger" type="submit">
                      ğŸ—‘ Eliminar
                    </button>
                  </form>
                  {% endif %}


                  <a class="btn btn-sm btn-outline-primary"
                    href="{{ url_for('reporte_pdf', reporte_id=r.id, v='B') }}"
                    target="_blank">
                    ğŸ“„ PDF
                  </a>

                </div>
              </div>
            </td>

          </tr>
        {% endfor %}
        </tbody>

      </table>
    </div>
  </div>

{% endif %}

{% endblock %}
